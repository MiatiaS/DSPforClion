//
// Created by 20614 on 25-4-26.
//

#include "myfir.h"
#include <stdlib.h>
#include "myfft.h"
#include "arm_math.h"
//参考文献https://www.cnblogs.com/Skyrim-sssuuu/p/18774935
//使用不同的滤波器，需要更改FIR_NUMTAPS_LENGTH 以及 pCoeffects 数组
//MATLAB fdatool 直接型FIR 选择97阶 生成.h头文件修改数组即可
#define FIR_LENGTH  8192          //要进行FIR滤波的数组长度
#define FIR_NUMTAPS_LENGTH 98     //滤波数组的长度
#define FIR_PSTATE_LENGTH (FIR_LENGTH + FIR_NUMTAPS_LENGTH - 1) //暂存数组长度

float32_t fir_pState[FIR_PSTATE_LENGTH] = {0.0f} ;
float32_t fir_result[FIR_LENGTH] = {0.0f} ;

const float32_t pCoeffects[FIR_NUMTAPS_LENGTH] =
{
    1.051426111e-07,2.352220179e-07,-1.841416086e-08,-1.058473572e-06,-2.16335502e-06,
    -9.558444845e-07,4.422098755e-06,1.079863159e-05,8.524658369e-06,-1.037106722e-05,
    -3.698538421e-05,-4.038729458e-05,8.950287338e-06,9.474914987e-05, 0.000135353941,
    3.834573363e-05,-0.0001852565911,-0.0003546658845,-0.0002234558488,0.0002600710723,
    0.0007598877419, 0.000708208885,-0.0001663969597,-0.001352637657,-0.001706773532,
    -0.000405495608, 0.001975340303, 0.003409265541, 0.001937763649,-0.002195288194,
    -0.005840832833,-0.005033101421,  0.00120846252, 0.008681025356,  0.01030351687,
     0.002228929661, -0.01108009368,  -0.0182903558,-0.009972218424,   0.0114290826,
      0.02968972549,  0.02543409728, -0.00656921044, -0.04698544741,   -0.059377864,
     -0.01389965974,   0.0882165283,   0.2082100958,   0.2889772058,   0.2889772058,
       0.2082100958,   0.0882165283, -0.01389965974,   -0.059377864, -0.04698544741,
     -0.00656921044,  0.02543409728,  0.02968972549, 0.0114290826,-0.009972218424,
      -0.0182903558, -0.01108009368, 0.002228929661,  0.01030351687, 0.008681025356,
      0.00120846252,-0.005033101421,-0.005840832833,-0.002195288194, 0.001937763649,
     0.003409265541, 0.001975340303,-0.000405495608,-0.001706773532,-0.001352637657,
    -0.0001663969597, 0.000708208885,0.0007598877419,0.0002600710723,-0.0002234558488,
    -0.0003546658845,-0.0001852565911,3.834573363e-05, 0.000135353941,9.474914987e-05,
    8.950287338e-06,-4.038729458e-05,-3.698538421e-05,-1.037106722e-05,8.524658369e-06,
    1.079863159e-05,4.422098755e-06,-9.558444845e-07,-2.16335502e-06,-1.058473572e-06,
    -1.841416086e-08,2.352220179e-07,1.051426111e-07
};
/*
 * 输入FFT句柄
 * 更新adc_val为滤波后的值
 * 如果更改滤波器传递函数请到.c
 */
void fir_calculate(FFT_Handler* handler)
{
    //初始化FIR结构体，规定要进行FIR滤波的数组长度，以及滤波数组的长度
    arm_fir_instance_f32* fir_S = (arm_fir_instance_f32 *)malloc(sizeof(arm_fir_instance_f32));
    arm_fir_init_f32(fir_S,FIR_NUMTAPS_LENGTH,pCoeffects,fir_pState,FIR_LENGTH);
    //FIR计算，结果存储到fir_result中
    arm_fir_f32(fir_S,handler->adc_val,fir_result,FIR_LENGTH);
    //FIR作用的基本单元是延迟器，所以数组前面的数据无效，通过这一步去除
    for(int i=0 ; i< FIR_NUMTAPS_LENGTH/2 ; i++)
    {
        fir_result[i] = 0.0f;
    }
    //这一步过后，更新adc_val的值为滤波后的值
    handler->adc_val = fir_result ;
}